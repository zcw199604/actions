name: 同步镜像 - tiktok-downloader

on:
  workflow_dispatch: {}
  schedule:
    # 北京时间 02:00（UTC+8）= UTC 18:00
    - cron: "0 18 * * *"

concurrency:
  group: sync-image-tiktok-downloader
  cancel-in-progress: false

permissions:
  contents: read
  issues: write

jobs:
  sync:
    name: 同步 latest（linux/amd64）
    runs-on: ubuntu-latest
    env:
      SOURCE_IMAGE: joeanamier/tiktok-downloader:latest
      PLATFORM: linux/amd64
    steps:
      - name: 校验配置
        id: config
        shell: bash
        env:
          TCR_REGISTRY: ${{ secrets.TCR_REGISTRY }}
          TCR_USERNAME: ${{ secrets.TCR_USERNAME }}
          TCR_PASSWORD: ${{ secrets.TCR_PASSWORD }}
          TCR_REPOSITORY_TIKTOK_DOWNLOADER: ${{ secrets.TCR_REPOSITORY_TIKTOK_DOWNLOADER || secrets.TCR_REPOSITORY }}
          ACR_REGISTRY: ${{ secrets.ACR_REGISTRY }}
          ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
          ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}
          ACR_REPOSITORY_TIKTOK_DOWNLOADER: ${{ secrets.ACR_REPOSITORY_TIKTOK_DOWNLOADER || secrets.ACR_REPOSITORY }}
        run: |
          set -euo pipefail
          check_group() {
            local group_name="$1"
            shift

            local all_empty="true"
            local missing=()
            local key
            for key in "$@"; do
              local value="${!key:-}"
              if [ -n "${value}" ]; then
                all_empty="false"
              else
                missing+=("${key}")
              fi
            done

            if [ "${all_empty}" = "true" ]; then
              echo "${group_name}_ENABLED=false"
              return 0
            fi

            if [ "${#missing[@]}" -gt 0 ]; then
              printf '%s 配置不完整，缺少 Secrets: %s\n' "${group_name}" "${missing[*]}" >&2
              exit 1
            fi

            echo "${group_name}_ENABLED=true"
          }

          tcr_enabled="$(check_group TCR TCR_REGISTRY TCR_USERNAME TCR_PASSWORD TCR_REPOSITORY_TIKTOK_DOWNLOADER | tail -n1 | cut -d= -f2)"
          acr_enabled="$(check_group ACR ACR_REGISTRY ACR_USERNAME ACR_PASSWORD ACR_REPOSITORY_TIKTOK_DOWNLOADER | tail -n1 | cut -d= -f2)"

          if [ "${tcr_enabled}" != "true" ] && [ "${acr_enabled}" != "true" ]; then
            echo "至少需要配置 TCR 或 ACR 一套 Secrets" >&2
            exit 1
          fi

          echo "TCR_ENABLED=${tcr_enabled}" >>"${GITHUB_ENV}"
          echo "ACR_ENABLED=${acr_enabled}" >>"${GITHUB_ENV}"
          echo "tcr_enabled=${tcr_enabled}" >>"${GITHUB_OUTPUT}"
          echo "acr_enabled=${acr_enabled}" >>"${GITHUB_OUTPUT}"

          if [ "${tcr_enabled}" = "true" ]; then
            if [[ "${TCR_REPOSITORY_TIKTOK_DOWNLOADER}" == *:* ]]; then
              echo "TCR_REPOSITORY_TIKTOK_DOWNLOADER 不应包含 tag（示例: namespace/repo）" >&2
              exit 1
            fi
            tcr_image="${TCR_REGISTRY}/${TCR_REPOSITORY_TIKTOK_DOWNLOADER}:latest"
            echo "TCR_IMAGE=${tcr_image}" >>"${GITHUB_ENV}"
            echo "tcr_image=${tcr_image}" >>"${GITHUB_OUTPUT}"
          fi

          if [ "${acr_enabled}" = "true" ]; then
            if [[ "${ACR_REPOSITORY_TIKTOK_DOWNLOADER}" == *:* ]]; then
              echo "ACR_REPOSITORY_TIKTOK_DOWNLOADER 不应包含 tag（示例: namespace/repo）" >&2
              exit 1
            fi
            acr_image="${ACR_REGISTRY}/${ACR_REPOSITORY_TIKTOK_DOWNLOADER}:latest"
            echo "ACR_IMAGE=${acr_image}" >>"${GITHUB_ENV}"
            echo "acr_image=${acr_image}" >>"${GITHUB_OUTPUT}"
          fi

      - name: Checkout
        uses: actions/checkout@v4

      - name: 设置 Docker Buildx（启用 BuildKit，支持 RUN heredoc）
        uses: docker/setup-buildx-action@v3

      - name: 登录腾讯云 TCR
        if: ${{ steps.config.outputs.tcr_enabled == 'true' }}
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.TCR_REGISTRY }}
          username: ${{ secrets.TCR_USERNAME }}
          password: ${{ secrets.TCR_PASSWORD }}

      - name: 登录阿里云 ACR
        if: ${{ steps.config.outputs.acr_enabled == 'true' }}
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: 拉取上游镜像（linux/amd64）
        shell: bash
        run: |
          set -euo pipefail
          docker pull --platform "${PLATFORM}" "${SOURCE_IMAGE}"

      - name: 计算源镜像 Digest
        shell: bash
        run: |
          set -euo pipefail
          source_digest="$(docker image inspect --format '{{index .RepoDigests 0}}' "${SOURCE_IMAGE}")"
          source_digest="${source_digest#*@}"
          echo "SOURCE_IMAGE_DIGEST=${source_digest}" >>"${GITHUB_ENV}"

      - name: 构建 Web API 包装镜像
        shell: bash
        run: |
          set -euo pipefail
          wrapper_sha="$(sha256sum docker/tiktok-downloader-webapi/Dockerfile docker/tiktok-downloader-webapi/entrypoint.sh | sha256sum | awk '{print $1}')"
          echo "WRAPPER_SHA=${wrapper_sha}" >>"${GITHUB_ENV}"
          # Use buildx/BuildKit to support shell heredoc in Dockerfile (e.g. RUN python - <<'PY' ...).
          docker buildx build \
            --platform "${PLATFORM}" \
            --load \
            --build-arg BASE_IMAGE="${SOURCE_IMAGE}" \
            --build-arg BASE_DIGEST="${SOURCE_IMAGE_DIGEST}" \
            --build-arg WRAPPER_REVISION="${GITHUB_SHA}" \
            --build-arg WRAPPER_SHA="${wrapper_sha}" \
            -f docker/tiktok-downloader-webapi/Dockerfile \
            -t tiktok-downloader-webapi:local \
            docker/tiktok-downloader-webapi

      - name: Smoke Test Web API（校验 /douyin/account/page）
        shell: bash
        run: |
          set -euo pipefail

          container_name="tiktok-downloader-webapi-smoke"
          tmp_dir="$(mktemp -d)"
          port="18080"

          cleanup() {
            docker rm -f "${container_name}" >/dev/null 2>&1 || true
            rm -rf "${tmp_dir}" || true
          }
          trap cleanup EXIT

          # Provide a non-empty cookie to avoid triggering the wrapper's headless Chromium cookie fetch
          # during this smoke test. The API schema does not require a real cookie.
          cat >"${tmp_dir}/settings.json" <<'JSON'
          {
            "run_command": "7",
            "cookie": "test=1"
          }
          JSON

          docker run -d --name "${container_name}" \
            -e RUN_COMMAND="7" \
            -e PORT="${port}" \
            -v "${tmp_dir}:/app/Volume" \
            -p "${port}:${port}" \
            tiktok-downloader-webapi:local

          # Wait until FastAPI is ready.
          for _ in $(seq 1 60); do
            if curl -fsS "http://127.0.0.1:${port}/openapi.json" -o "${tmp_dir}/openapi.json"; then
              break
            fi
            sleep 1
          done

          if [ ! -s "${tmp_dir}/openapi.json" ]; then
            echo "openapi.json not available; container logs:" >&2
            docker logs "${container_name}" || true
            exit 1
          fi

          jq -e '.paths["/douyin/account/page"]' "${tmp_dir}/openapi.json" >/dev/null

      - name: 推送至腾讯云 TCR（如有更新）
        if: ${{ steps.config.outputs.tcr_enabled == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          if docker pull --platform "${PLATFORM}" "${TCR_IMAGE}"; then
            remote_base_digest="$(docker image inspect "${TCR_IMAGE}" | jq -r '((.[0].Config.Labels // {})["org.opencontainers.image.base.digest"]) // ""')"
            remote_wrapper_sha="$(docker image inspect "${TCR_IMAGE}" | jq -r '((.[0].Config.Labels // {})["com.helloagents.wrapper.sha"]) // ""')"
            if [ "${remote_base_digest}" = "${SOURCE_IMAGE_DIGEST}" ] && [ "${remote_wrapper_sha}" = "${WRAPPER_SHA}" ]; then
              echo "腾讯云 TCR 目标镜像已是最新（base digest + wrapper sha 相同），跳过推送"
              echo "TCR_SYNC_RESULT=skipped" >>"${GITHUB_ENV}"
              exit 0
            fi
          else
            echo "腾讯云 TCR 目标镜像不存在或无法拉取，将执行推送"
          fi
          docker tag "tiktok-downloader-webapi:local" "${TCR_IMAGE}"
          docker push "${TCR_IMAGE}"
          echo "TCR_SYNC_RESULT=pushed" >>"${GITHUB_ENV}"

      - name: 推送至阿里云 ACR（如有更新）
        if: ${{ steps.config.outputs.acr_enabled == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          if docker pull --platform "${PLATFORM}" "${ACR_IMAGE}"; then
            remote_base_digest="$(docker image inspect "${ACR_IMAGE}" | jq -r '((.[0].Config.Labels // {})["org.opencontainers.image.base.digest"]) // ""')"
            remote_wrapper_sha="$(docker image inspect "${ACR_IMAGE}" | jq -r '((.[0].Config.Labels // {})["com.helloagents.wrapper.sha"]) // ""')"
            if [ "${remote_base_digest}" = "${SOURCE_IMAGE_DIGEST}" ] && [ "${remote_wrapper_sha}" = "${WRAPPER_SHA}" ]; then
              echo "阿里云 ACR 目标镜像已是最新（base digest + wrapper sha 相同），跳过推送"
              echo "ACR_SYNC_RESULT=skipped" >>"${GITHUB_ENV}"
              exit 0
            fi
          else
            echo "阿里云 ACR 目标镜像不存在或无法拉取，将执行推送"
          fi
          docker tag "tiktok-downloader-webapi:local" "${ACR_IMAGE}"
          docker push "${ACR_IMAGE}"
          echo "ACR_SYNC_RESULT=pushed" >>"${GITHUB_ENV}"

      - name: 写入执行摘要
        if: ${{ success() }}
        shell: bash
        run: |
          set -euo pipefail
          {
            echo "### 镜像同步结果"
            echo "- source: \`${SOURCE_IMAGE}\`"
            echo "- source_digest: \`${SOURCE_IMAGE_DIGEST:-unknown}\`"
            echo "- wrapper_sha: \`${WRAPPER_SHA:-unknown}\`"
            echo "- platform: \`${PLATFORM}\`"
            if [ "${TCR_ENABLED:-false}" = "true" ]; then
              echo "- tcr: \`${TCR_IMAGE}\` (${TCR_SYNC_RESULT:-unknown})"
            else
              echo "- tcr: （未启用）"
            fi
            if [ "${ACR_ENABLED:-false}" = "true" ]; then
              echo "- acr: \`${ACR_IMAGE}\` (${ACR_SYNC_RESULT:-unknown})"
            else
              echo "- acr: （未启用）"
            fi
            echo "- run: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          } >>"${GITHUB_STEP_SUMMARY}"

      - name: 同步失败创建/更新 Issue
        if: ${{ failure() }}
        uses: actions/github-script@v7
        with:
          script: |
            const title = "镜像同步失败: tiktok-downloader";
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const source = process.env.SOURCE_IMAGE || "（未知源镜像）";
            const tcr = process.env.TCR_IMAGE || "（未配置）";
            const acr = process.env.ACR_IMAGE || "（未配置）";
            const platform = process.env.PLATFORM || "（未知平台）";
            const body = [
              `同步任务失败，请查看运行日志：${runUrl}`,
              "",
              `源镜像：\`${source}\``,
              "目标镜像：",
              `- TCR：\`${tcr}\``,
              `- ACR：\`${acr}\``,
              `平台：\`${platform}\``,
            ].join("\n");

            const { owner, repo } = context.repo;
            const issues = await github.paginate(github.rest.issues.listForRepo, {
              owner,
              repo,
              state: "open",
              per_page: 100,
            });
            const existing = issues.find((i) => i.title === title);
            if (existing) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: existing.number,
                body,
              });
              core.info(`已在 Issue #${existing.number} 追加失败信息`);
            } else {
              await github.rest.issues.create({ owner, repo, title, body });
              core.info("已创建失败 Issue");
            }
