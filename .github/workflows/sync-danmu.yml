name: 同步镜像 - danmu-api

on:
  workflow_dispatch: {}
  schedule:
    # 北京时间 02:00（UTC+8）= UTC 18:00
    - cron: "0 18 * * *"

concurrency:
  group: sync-image-danmu-api
  cancel-in-progress: false

permissions:
  contents: read
  issues: write

jobs:
  sync:
    name: 同步 latest（linux/amd64）
    runs-on: ubuntu-latest
    env:
      SOURCE_IMAGE: logvar/danmu-api:latest
      PLATFORM: linux/amd64
    steps:
      - name: 校验配置
        id: config
        shell: bash
        env:
          TCR_REGISTRY: ${{ secrets.TCR_REGISTRY }}
          TCR_USERNAME: ${{ secrets.TCR_USERNAME }}
          TCR_PASSWORD: ${{ secrets.TCR_PASSWORD }}
          TCR_REPOSITORY_DANMU_API: ${{ secrets.TCR_REPOSITORY_DANMU_API || secrets.TCR_REPOSITORY_DANMU || secrets.TCR_REPOSITORY }}
          ACR_REGISTRY: ${{ secrets.ACR_REGISTRY }}
          ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
          ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}
          ACR_REPOSITORY_DANMU_API: ${{ secrets.ACR_REPOSITORY_DANMU_API || secrets.ACR_REPOSITORY_DANMU || secrets.ACR_REPOSITORY }}
        run: |
          set -euo pipefail
          check_group() {
            local group_name="$1"
            shift

            local all_empty="true"
            local missing=()
            local key
            for key in "$@"; do
              local value="${!key:-}"
              if [ -n "${value}" ]; then
                all_empty="false"
              else
                missing+=("${key}")
              fi
            done

            if [ "${all_empty}" = "true" ]; then
              echo "${group_name}_ENABLED=false"
              return 0
            fi

            if [ "${#missing[@]}" -gt 0 ]; then
              printf '%s 配置不完整，缺少 Secrets: %s\n' "${group_name}" "${missing[*]}" >&2
              exit 1
            fi

            echo "${group_name}_ENABLED=true"
          }

          tcr_enabled="$(check_group TCR TCR_REGISTRY TCR_USERNAME TCR_PASSWORD TCR_REPOSITORY_DANMU_API | tail -n1 | cut -d= -f2)"
          acr_enabled="$(check_group ACR ACR_REGISTRY ACR_USERNAME ACR_PASSWORD ACR_REPOSITORY_DANMU_API | tail -n1 | cut -d= -f2)"

          if [ "${tcr_enabled}" != "true" ] && [ "${acr_enabled}" != "true" ]; then
            echo "至少需要配置 TCR 或 ACR 一套 Secrets" >&2
            exit 1
          fi

          echo "TCR_ENABLED=${tcr_enabled}" >>"${GITHUB_ENV}"
          echo "ACR_ENABLED=${acr_enabled}" >>"${GITHUB_ENV}"
          echo "tcr_enabled=${tcr_enabled}" >>"${GITHUB_OUTPUT}"
          echo "acr_enabled=${acr_enabled}" >>"${GITHUB_OUTPUT}"

          if [ "${tcr_enabled}" = "true" ]; then
            if [[ "${TCR_REPOSITORY_DANMU_API}" == *:* ]]; then
              echo "TCR_REPOSITORY_DANMU_API 不应包含 tag（示例: namespace/repo）" >&2
              exit 1
            fi
            tcr_image="${TCR_REGISTRY}/${TCR_REPOSITORY_DANMU_API}:latest"
            echo "TCR_IMAGE=${tcr_image}" >>"${GITHUB_ENV}"
            echo "tcr_image=${tcr_image}" >>"${GITHUB_OUTPUT}"
          fi

          if [ "${acr_enabled}" = "true" ]; then
            if [[ "${ACR_REPOSITORY_DANMU_API}" == *:* ]]; then
              echo "ACR_REPOSITORY_DANMU_API 不应包含 tag（示例: namespace/repo）" >&2
              exit 1
            fi
            acr_image="${ACR_REGISTRY}/${ACR_REPOSITORY_DANMU_API}:latest"
            echo "ACR_IMAGE=${acr_image}" >>"${GITHUB_ENV}"
            echo "acr_image=${acr_image}" >>"${GITHUB_OUTPUT}"
          fi

      - name: 登录腾讯云 TCR
        if: ${{ steps.config.outputs.tcr_enabled == 'true' }}
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.TCR_REGISTRY }}
          username: ${{ secrets.TCR_USERNAME }}
          password: ${{ secrets.TCR_PASSWORD }}

      - name: 登录阿里云 ACR
        if: ${{ steps.config.outputs.acr_enabled == 'true' }}
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: 拉取上游镜像（linux/amd64）
        shell: bash
        run: |
          set -euo pipefail
          docker pull --platform "${PLATFORM}" "${SOURCE_IMAGE}"

      - name: 计算源镜像标识（平台 digest + image id）
        shell: bash
        run: |
          set -euo pipefail

          image_repo() {
            local image_ref="$1"
            image_ref="${image_ref%@*}"
            local last_segment="${image_ref##*/}"
            if [[ "${last_segment}" == *:* ]]; then
              printf '%s\n' "${image_ref%:*}"
            else
              printf '%s\n' "${image_ref}"
            fi
          }

          get_platform_digest() {
            local image_ref="$1"
            local repo_ref="$2"
            local prefix="${repo_ref}@"
            docker image inspect --format '{{range .RepoDigests}}{{println .}}{{end}}' "${image_ref}" \
              | awk -v prefix="${prefix}" 'index($0, prefix) == 1 {sub("^[^@]+@", "", $0); print; exit}'
          }

          source_repo="$(image_repo "${SOURCE_IMAGE}")"
          source_platform_digest="$(get_platform_digest "${SOURCE_IMAGE}" "${source_repo}")"
          source_id="$(docker image inspect --format '{{.Id}}' "${SOURCE_IMAGE}")"

          if [ -z "${source_platform_digest}" ]; then
            echo "无法解析源镜像平台 manifest digest: ${SOURCE_IMAGE}" >&2
            exit 1
          fi

          echo "SOURCE_IMAGE_REPO=${source_repo}" >>"${GITHUB_ENV}"
          echo "SOURCE_PLATFORM_DIGEST=${source_platform_digest}" >>"${GITHUB_ENV}"
          echo "SOURCE_IMAGE_ID=${source_id}" >>"${GITHUB_ENV}"

      - name: 推送至腾讯云 TCR（如有更新）
        if: ${{ steps.config.outputs.tcr_enabled == 'true' }}
        shell: bash
        run: |
          set -euo pipefail

          image_repo() {
            local image_ref="$1"
            image_ref="${image_ref%@*}"
            local last_segment="${image_ref##*/}"
            if [[ "${last_segment}" == *:* ]]; then
              printf '%s\n' "${image_ref%:*}"
            else
              printf '%s\n' "${image_ref}"
            fi
          }

          get_platform_digest() {
            local image_ref="$1"
            local repo_ref="$2"
            local prefix="${repo_ref}@"
            docker image inspect --format '{{range .RepoDigests}}{{println .}}{{end}}' "${image_ref}" \
              | awk -v prefix="${prefix}" 'index($0, prefix) == 1 {sub("^[^@]+@", "", $0); print; exit}'
          }

          tcr_repo="$(image_repo "${TCR_IMAGE}")"

          if docker pull --platform "${PLATFORM}" "${TCR_IMAGE}"; then
            tcr_platform_digest="$(get_platform_digest "${TCR_IMAGE}" "${tcr_repo}")"
            tcr_id="$(docker image inspect --format '{{.Id}}' "${TCR_IMAGE}")"
            echo "TCR_TARGET_PLATFORM_DIGEST=${tcr_platform_digest:-unknown}" >>"${GITHUB_ENV}"
            echo "TCR_TARGET_IMAGE_ID=${tcr_id:-unknown}" >>"${GITHUB_ENV}"

            if [ -n "${tcr_platform_digest}" ] \
              && [ "${tcr_platform_digest}" = "${SOURCE_PLATFORM_DIGEST}" ] \
              && [ "${tcr_id}" = "${SOURCE_IMAGE_ID}" ]; then
              echo "腾讯云 TCR 目标镜像已是最新（平台 manifest digest + image id 均一致），跳过推送"
              echo "TCR_SYNC_RESULT=skipped" >>"${GITHUB_ENV}"
              exit 0
            fi
            if [ -z "${tcr_platform_digest}" ]; then
              echo "腾讯云 TCR 目标镜像平台 manifest digest 解析失败，将执行推送"
            fi
          else
            echo "腾讯云 TCR 目标镜像不存在或无法拉取，将执行推送"
            echo "TCR_TARGET_PLATFORM_DIGEST=unavailable" >>"${GITHUB_ENV}"
            echo "TCR_TARGET_IMAGE_ID=unavailable" >>"${GITHUB_ENV}"
          fi
          docker tag "${SOURCE_IMAGE}" "${TCR_IMAGE}"
          docker push "${TCR_IMAGE}"
          echo "TCR_SYNC_RESULT=pushed" >>"${GITHUB_ENV}"

      - name: 推送至阿里云 ACR（如有更新）
        if: ${{ steps.config.outputs.acr_enabled == 'true' }}
        shell: bash
        run: |
          set -euo pipefail

          image_repo() {
            local image_ref="$1"
            image_ref="${image_ref%@*}"
            local last_segment="${image_ref##*/}"
            if [[ "${last_segment}" == *:* ]]; then
              printf '%s\n' "${image_ref%:*}"
            else
              printf '%s\n' "${image_ref}"
            fi
          }

          get_platform_digest() {
            local image_ref="$1"
            local repo_ref="$2"
            local prefix="${repo_ref}@"
            docker image inspect --format '{{range .RepoDigests}}{{println .}}{{end}}' "${image_ref}" \
              | awk -v prefix="${prefix}" 'index($0, prefix) == 1 {sub("^[^@]+@", "", $0); print; exit}'
          }

          acr_repo="$(image_repo "${ACR_IMAGE}")"

          if docker pull --platform "${PLATFORM}" "${ACR_IMAGE}"; then
            acr_platform_digest="$(get_platform_digest "${ACR_IMAGE}" "${acr_repo}")"
            acr_id="$(docker image inspect --format '{{.Id}}' "${ACR_IMAGE}")"
            echo "ACR_TARGET_PLATFORM_DIGEST=${acr_platform_digest:-unknown}" >>"${GITHUB_ENV}"
            echo "ACR_TARGET_IMAGE_ID=${acr_id:-unknown}" >>"${GITHUB_ENV}"

            if [ -n "${acr_platform_digest}" ] \
              && [ "${acr_platform_digest}" = "${SOURCE_PLATFORM_DIGEST}" ] \
              && [ "${acr_id}" = "${SOURCE_IMAGE_ID}" ]; then
              echo "阿里云 ACR 目标镜像已是最新（平台 manifest digest + image id 均一致），跳过推送"
              echo "ACR_SYNC_RESULT=skipped" >>"${GITHUB_ENV}"
              exit 0
            fi
            if [ -z "${acr_platform_digest}" ]; then
              echo "阿里云 ACR 目标镜像平台 manifest digest 解析失败，将执行推送"
            fi
          else
            echo "阿里云 ACR 目标镜像不存在或无法拉取，将执行推送"
            echo "ACR_TARGET_PLATFORM_DIGEST=unavailable" >>"${GITHUB_ENV}"
            echo "ACR_TARGET_IMAGE_ID=unavailable" >>"${GITHUB_ENV}"
          fi
          docker tag "${SOURCE_IMAGE}" "${ACR_IMAGE}"
          docker push "${ACR_IMAGE}"
          echo "ACR_SYNC_RESULT=pushed" >>"${GITHUB_ENV}"

      - name: 写入执行摘要
        if: ${{ success() }}
        shell: bash
        run: |
          set -euo pipefail
          {
            echo "### 镜像同步结果"
            echo "- source: \`${SOURCE_IMAGE}\`"
            echo "- source_platform_digest: \`${SOURCE_PLATFORM_DIGEST:-unknown}\`"
            echo "- source_image_id: \`${SOURCE_IMAGE_ID:-unknown}\`"
            echo "- platform: \`${PLATFORM}\`"
            if [ "${TCR_ENABLED:-false}" = "true" ]; then
              echo "- tcr: \`${TCR_IMAGE}\` (${TCR_SYNC_RESULT:-unknown})"
              echo "  - tcr_platform_digest: \`${TCR_TARGET_PLATFORM_DIGEST:-unknown}\`"
              echo "  - tcr_image_id: \`${TCR_TARGET_IMAGE_ID:-unknown}\`"
            else
              echo "- tcr: （未启用）"
            fi
            if [ "${ACR_ENABLED:-false}" = "true" ]; then
              echo "- acr: \`${ACR_IMAGE}\` (${ACR_SYNC_RESULT:-unknown})"
              echo "  - acr_platform_digest: \`${ACR_TARGET_PLATFORM_DIGEST:-unknown}\`"
              echo "  - acr_image_id: \`${ACR_TARGET_IMAGE_ID:-unknown}\`"
            else
              echo "- acr: （未启用）"
            fi
            echo "- run: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          } >>"${GITHUB_STEP_SUMMARY}"

      - name: 同步失败创建/更新 Issue
        if: ${{ failure() }}
        uses: actions/github-script@v8
        with:
          script: |
            const title = "镜像同步失败: danmu-api";
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const source = process.env.SOURCE_IMAGE || "（未知源镜像）";
            const tcr = process.env.TCR_IMAGE || "（未配置）";
            const acr = process.env.ACR_IMAGE || "（未配置）";
            const platform = process.env.PLATFORM || "（未知平台）";
            const body = [
              `同步任务失败，请查看运行日志：${runUrl}`,
              "",
              `源镜像：\`${source}\``,
              "目标镜像：",
              `- TCR：\`${tcr}\``,
              `- ACR：\`${acr}\``,
              `平台：\`${platform}\``,
            ].join("\n");

            const { owner, repo } = context.repo;
            const issues = await github.paginate(github.rest.issues.listForRepo, {
              owner,
              repo,
              state: "open",
              per_page: 100,
            });
            const existing = issues.find((i) => i.title === title);
            if (existing) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: existing.number,
                body,
              });
              core.info(`已在 Issue #${existing.number} 追加失败信息`);
            } else {
              await github.rest.issues.create({ owner, repo, title, body });
              core.info("已创建失败 Issue");
            }
